# 梯度判据问题分析 - 投影掩盖HJ演化退化

**日期**: 2025-10-23  
**问题类型**: 重初始化判据逻辑错误

---

## 问题发现

### 实验观察

通过开关`ENABLE_HARD_PROJECTION`进行对比测试：

| 投影状态 | 梯度偏差 P95 | 触发情况 |
|---------|-------------|---------|
| **投影开启** (`ENABLE_HARD_PROJECTION = true`) | 0.44 | 每步触发 (0.44 > 0.20) |
| **投影关闭** (`ENABLE_HARD_PROJECTION = false`) | 1.0 | 每步触发 (1.0 > 0.20) |

**关键发现**：
- HJ演化后，未经投影的梯度偏差P95高达**1.0**
- 硬投影将梯度偏差降低到**0.44**（修正了56%）
- 说明HJ演化确实导致符号距离性质严重退化

---

## 当前代码逻辑

### fiber_levelset.m (第474-483行)

```matlab
% === 重初始化判据说明（刻意设计） ===
% 分离两个判据的输入（2025-10-23 修复）：
%   1. 变化量判据：基于lsf_after_HJ（HJ演化后、投影前），排除投影修正的影响
%   2. 梯度偏差判据：基于lsf（投影后），使用最终状态的梯度质量
% 原因：
%   - HJ演化会导致符号距离性质退化，需要监控变化量
%   - 投影会修正水平集，需要基于投影后的最终状态评估梯度质量
%   - 避免投影修正触发"变化量过大"，但保留对梯度质量的正确评估
[do_reinit, reinit_reason] = should_reinitialize(lsf_after_HJ, lsf, lsf_before, ...
    iter_since_last_reinit, iter, params);
```

**参数说明**：
- 第1个参数 `lsf_after_HJ`：用于变化量判据
- 第2个参数 `lsf`（投影后）：用于梯度偏差判据 ← **问题所在**
- 第3个参数 `lsf_before`：参考状态

---

## 问题分析

### 逻辑矛盾

**当前设计思路**：
- "投影会修正水平集，需要基于投影后的最终状态评估梯度质量"
- 梯度判据使用投影后的`lsf`（P95=0.44）

**问题**：
1. **投影是临时修正，不能替代重初始化**
   - 投影只是在每步强制拉回目标层，不改变整个场的符号距离性质
   - 真实的退化（P95=1.0）被掩盖了

2. **重初始化的目的被削弱**
   - 重初始化应该恢复 |∇φ| ≈ 1 的符号距离性质
   - 如果HJ演化后P95=1.0，说明**确实需要重初始化**
   - 但因为监控投影后的状态（P95=0.44），导致不触发或触发延迟

3. **投影和重初始化的角色混淆**
   - **投影**：局部修正，强制锚定零等值线位置
   - **重初始化**：全局恢复符号距离性质
   - 投影**不能替代**重初始化的作用

### 具体影响

**场景1**：HJ演化后梯度退化严重（P95=1.0）
```
HJ演化后: grad_mag ∈ [0, 2], P95偏差=1.0  ← 严重退化，应该重初始化
投影后:   grad_mag部分修正, P95偏差=0.44  ← 被当作"梯度良好"
结果:     不触发重初始化（0.44 > 0.20但不是严重到1.0）
后果:     长期累积，符号距离性质持续退化
```

**场景2**：当前测试中投影关闭
```
HJ演化后: P95=1.0
判据监控: 投影后的lsf（但投影关闭，所以还是1.0）
结果:     每步触发（1.0 > 0.20）
```

---

## 正确的设计思路

### 重初始化判据应该监控什么？

**核心原则**：监控**HJ演化导致的符号距离性质退化**，而非投影修正后的状态

**正确的逻辑**：
```
HJ演化 → 检查梯度退化（基于lsf_after_HJ）→ 如果严重 → 重初始化
            ↓
         梯度OK → 投影修正零等值线位置 → 继续演化
```

**错误的逻辑**（当前）：
```
HJ演化 → 投影修正 → 检查梯度退化（基于投影后lsf）→ 看起来OK → 不重初始化
                                                      ↓
                                                  实际已退化
```

---

## 修复建议

### 方案：梯度判据也基于HJ演化后的状态

```matlab
[do_reinit, reinit_reason] = should_reinitialize(lsf_after_HJ, lsf_after_HJ, lsf_before, ...
    iter_since_last_reinit, iter, params);
                                                  ^^^^^^^^^^^  ^^^^^^^^^^^
                                                  变化量判据   梯度判据（都基于HJ后）
```

**原因**：
1. 两个判据都应该监控HJ演化的影响
2. 变化量判据：排除投影修正的影响 ✓
3. 梯度偏差判据：监控HJ演化导致的真实退化 ✓
4. 投影只是临时修正，不改变判据

**阈值调整**：
```matlab
config/get_fiber_optimization_params.m:48
base.levelset.gradient_deviation_tol = 0.80;  // 因为HJ后P95≈1.0，设为0.8合理
```

**设置0.80的原因**：
- 实测HJ演化后P95=1.0
- 0.80阈值意味着：当95%的窄带点梯度模偏离1的量超过0.8时才重初始化
- 既能捕获严重退化（如当前的1.0），又不会过于频繁触发
- P95<0.8说明大部分点梯度质量尚可，可以继续演化

---

## 预期效果

### 修复后的行为

```
迭代 N:
  HJ演化 → grad P95 = 0.15 → 不触发重初始化（0.15 < 0.80）→ 投影修正 → 继续
  
迭代 N+M:
  HJ演化 → grad P95 = 0.85 → 触发重初始化（0.85 > 0.80）→ FMM恢复|∇φ|≈1
```

### 触发频率预期

- **前100步**：主要由固定频率触发（每5步），偶尔由梯度退化触发
- **后400步**：主要由固定频率触发（每10步）
- **总计**：约40-70次/500步（vs 当前500次）

---

## 请Codex评审的问题

### 核心问题

1. **我的分析是否正确**？
   - 投影后的梯度偏差（P95=0.44）不应该作为重初始化判据
   - 应该监控HJ演化后、投影前的真实退化（P95=1.0）

2. **修复方案是否合理**？
   - 两个判据都基于`lsf_after_HJ`
   - 阈值设为0.80

3. **是否有更好的设计**？
   - 是否应该分别设置两个判据的阈值？
   - 投影和重初始化的配合是否需要调整？

### 潜在风险

1. **如果梯度判据基于投影前的lsf**：
   - P95可能经常>0.8，导致频繁重初始化
   - 但这可能才是**正确的行为**（HJ演化确实在破坏符号距离性质）

2. **投影的角色**：
   - 如果投影能持续修正梯度，是否可以减少重初始化？
   - 但投影只是局部修正，不改变全局符号距离性质

### 需要确认

- 论文中对于投影和重初始化的配合有何说明？
- HJ演化导致P95=1.0是否在预期范围内？
- 阈值0.80是否过于宽松？

---

## 附录：代码位置

- `fiber_levelset.m:474-483` - 重初始化调用
- `should_reinitialize.m:39-68` - 梯度偏差判据实现
- `config/get_fiber_optimization_params.m:48` - 阈值配置

