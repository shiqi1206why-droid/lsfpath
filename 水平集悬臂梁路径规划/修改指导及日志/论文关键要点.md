# 论文关键要点（水平集路径规划 / 纤维路径优化）

本文档提炼论文“水平集方法用于纤维路径规划/方向优化”的核心思想、符号体系与关键公式，并给出与当前实现项目的对应关系、参数建议与验证指标。可直接作为实现对照与代码审阅清单。

---

## 1. 摘要与问题定义

- 在给定结构、载荷与边界条件下，寻找连续纤维的路径/方向场，使目标函数（通常为柔度或应变能）最优。
- 使用水平集函数 φ(x,y) 的零等值线表示“主纤维路径”；纤维方向取为水平集等值线的切向（等价于与 ∇φ 垂直）。

---

## 2. 符号与坐标约定

- φ: 水平集函数（有符号距离的近似），φ=0 为主路径。
- ∇φ = (φ_x, φ_y): 水平集梯度。
- θ: 纤维方向角（模 π），单位弧度。
- Q, C, S: 材料刚度矩阵（材料坐标系 Q，全局坐标系 C），柔度矩阵 S=C^{-1}。
- ε, σ: 单元应变与应力向量（平面应力，维度3）。
- Δt: 物理时间步（演化步长）；h=min(dx,dy): 最小网格步长；α: 能量分配因子（常取 0.5）。

坐标体系：实现中可使用“单元索引坐标”绘图，但物理量的离散均以 dx, dy 为尺度；两者应一致映射。

---

## 3. 水平集基础

### 3.1 Hamilton–Jacobi 演化方程

∂φ/∂t + V |∇φ| = 0

离散（显式Upwind）：

φ^{n+1} = φ^n − Δt · V · |∇φ|_upwind

其中 upwind 梯度按 V 的符号选择前/后向差分，确保数值稳定。

### 3.2 符号距离与重初始化

目标：保持 |∇φ| ≈ 1。

重初始化伪时间方程：

∂φ/∂τ + sgn(φ₀) (|∇φ| − 1) = 0

实现可用 HJ 迭代或 FMM（快速行进法）生成距离场；零水平集掩膜需锁定保持位置不漂移。

---

## 4. 初始化与等距约束

边界符号距离：

φ_b(x,y) = d_out(x,y) − d_in(x,y)

主路径目标场：

φ_main(x,y) = φ_b(x,y) + Δφ

零等值线 φ_main=0 ⇔ φ_b = −Δφ，即“与材料边界内侧等距 Δφ 的曲线”。

Δφ 选择：0.5h ~ 2h；必须小于局部最小厚度的一半，避免路径消失。

---

## 5. 由水平集到纤维方向

设 n_f = (−φ_y, φ_x)/|∇φ| 为等值线切向单位向量，则纤维角：

θ = atan2(n_{f,y}, n_{f,x}) = π/2 + atan2(φ_y, φ_x)

实现中令 θ ∈ [0, π)（模 π）。

---

## 6. 正交各向异性材料与坐标变换

材料坐标系刚度：

Q = \[\[Q11, Q12, 0\], \[Q12, Q22, 0\], \[0,0,Q66\]\]

Q11 = E_L/(1−ν_LT·ν_TL),  Q22 = E_T/(1−ν_LT·ν_TL),  Q12 = ν_LT·E_T/(1−ν_LT·ν_TL),  Q66 = G_LT。

坐标变换矩阵（c=cosθ, s=sinθ）：

T(θ) = \[\[c², s², 2sc\], \[s², c², −2sc\], \[−sc, sc, c²−s²\]\]

全局刚度：C(θ) = T(θ)^T · Q · T(θ)

导数：dT/dθ 与 dC/dθ = (dT/dθ)^T·Q·T + T^T·Q·(dT/dθ)（显式表达式按实现给出）。

---

## 7. 目标函数与伴随灵敏度

以单元能量 E 为例（或等价的柔度）：

∂E/∂θ = (−1 + 2α − α²) · ε^T (∂C/∂θ) ε
        + α² · σ^T (∂S/∂θ) σ
        + (2α² − 2α) · ε^T (∂C/∂θ) σ

S = C^{-1}，实现中用 rcond 检查并在必要时正则化 C，使用线性求解（\）代替显式求逆以增强稳定性。

---

## 8. 链式法则：从 ∂E/∂θ 到 ∂E/∂φ

θ = π/2 + atan2(φ_y, φ_x)

∂θ/∂φ_x = −φ_y / (φ_x² + φ_y²),   ∂θ/∂φ_y = φ_x / (φ_x² + φ_y²)

对每个单元的角度灵敏度 ∂E/∂θ 通过链式法则分配到周围网格节点上的 ∂E/∂φ，形成节点速度源项。

---

## 9. 速度场与演化策略

基础法向速度（窄带内）：V_base = −(∂E/∂φ)

零均值/幅度调节：从窄带内加权均值中性化，按分位数限幅，满足 CFL 条件。

等距（形状）约束项（论文关键思想的实现落点）：

V ← V_base − λ_dist · (φ − φ_anchor)

其中 φ_anchor = φ_b + Δφ（扩展到含边界的网格尺寸），λ_dist 为权重（建议 0.1~1）。该项把主路径“拉回”到与边界等距的位置，只允许小幅随力学场调整，从而保证初始化与结果走向一致性。

时间步长（CFL）：

Δt ≤ CFL · h / q_{0.99}(|V|)，CFL≈0.3，q_{0.99} 为 99% 分位数稳健估计。

---

## 10. 重初始化与稳定性

- 每隔若干步对 φ 进行重初始化（HJ 或 FMM），并锁定零水平集种子点，维持 |∇φ|≈1。
- 过滤 Inf/NaN；角度计算在 |∇φ| 很小或出现非有限梯度时采用保底策略。
- C 条件数差时加入轻微正则化，使用 S = C\I 代替 inv(C)。

---


---

## 11. 验证指标与实验流程

1) 初始化诊断：
   - 偏移距离样本分布围绕 Δφ，薄壁比例合理。
   - |∇φ| 直方图在 1 附近。

2) 优化过程：
   - 柔度单调下降或振荡收敛；FCS 上升。

3) 结果一致性：
   - Figure 3 的 φ=0 与 Figure 2 的等距曲线走向一致，仅有小幅差异。

最小复现实验：
   - 载入拓扑 → 初始化（Δφ=h*0.8）→ 启用 λ_dist=0.3 的等距约束 → 100 步演化 → 输出上述三类图与统计。

---

## 12. 结论

论文方法的关键在于：用水平集表达纤维路径，将“等距于边界”的几何先验通过势能/保真项显式注入到速度场中，与力学灵敏度共同决定演化方向。这样既符合工艺/几何约束，又能朝着力学最优收敛，避免路径从边界附近大幅漂移。


