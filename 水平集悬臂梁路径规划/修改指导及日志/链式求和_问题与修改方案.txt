【链式求和噪声与窄带判据修正说明】

一、问题现象（来自诊断日志的典型表现）
- “梯度模：最小≈0、最大>2、平均<1”，|∇φ| 明显偏离 1；
- “链式法分母退化次数”成千上万；
- 节点灵敏度出现极端大值/非有限值，导致 dt→0（预测最大角度变化≈0°）；
- V_fid 与 V_shape 比值异常（或统计不一致），曲率项放大噪声。

二、根本原因（最核心的一条）
- 链式求和把“不该参与”的单元也纳入了：当前策略是
  “band_mask=|φ|≤h + 元素 3×3 邻域任一点入带 ⇒ 整个元素参与求和”。
  这等价于“只要沾边就算”，会把大量未被零水平集（φ=0）穿过的单元收进来。
  这些远离零线的单元常出现 |∇φ|≈0 → 链式分母退化 → 灵敏度爆炸/NaN/Inf → dt 被压成 0。

三、论文对应（为何必须收窄）
- 节点层链式法则：∂E/∂φ_i = Σ_{e∈N(i)} (∂E/∂θ_e)(∂θ_e/∂φ_i)，
  其中 N(i) 是“与节点 i 相邻、且被主路径（φ=0）穿过的单元”。
- 因此，离散实现必须“只对被 φ=0 实际穿越的单元求和”，靠近≠穿越。

四、修改思路（从宽松 OR 规则 → 严格穿越 + 软裁剪）
1) 硬筛：零水平集穿越判据（元素级）
   - 取四角 φ11, φ12, φ21, φ22（左下/右下/左上/右上）；
   - 边穿越（任一满足即可）：
     (φ11*φ12<0) or (φ21*φ22<0) or (φ11*φ21<0) or (φ12*φ22<0)
   - 近零容差：min(|φij|) < φ_zero_tol（如 1e-12 或 0.05·h）。
   - 不满足者：continue（该元素不纳入链式求和）。

2) 软裁剪：最小 |φ| 与带宽比较（元素级）
   - min_abs_phi_in_cell ≤ bandwidth 才参与；建议 bandwidth=2~3·h；
   - 这是工程稳定化措施，不违背论文“只对穿越单元求和”的原则。

3) 分母正则化与鲁棒性
   - dθ/dφ 中对 φ_x²+φ_y² 采用较大正则：ε ≈ (0.5~1.0)·h；
   - 丢弃非有限值：若贡献非有限，跳过对该节点的累加；
   - 只在窄带内统计诊断指标与去均值等权重。

4) 临时关闭曲率/目标牵引（先稳住主项）
   - γ_curv=0、λ_fid=0，把数值稳住后再渐进开启；
   - 速度的幅值缩放/去均值也先关闭，让 Δt 成为唯一“步长旋钮”。



结论：把“3×3 邻域沾边就算”改为“必须被 φ=0 实际穿越（再辅以带宽软裁剪）”，是与论文一致的离散实现，能显著降低链式求和噪声并恢复稳定收敛。
